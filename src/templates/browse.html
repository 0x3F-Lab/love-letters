{% extends "base.html" %} 
{% block title %} Browse Posts {% endblock %} 

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">All Posts</h1>
    <div class="sort-posts">
        <form action="" method="get">
            <label for="sort">Sort by:</label>
            <select name="sort" id="sort" onchange="this.form.submit()">
                <option value="" disabled selected>Choose</option>
                <option value="newest" {% if request.args.get('sort', 'newest') == 'newest' %}selected{% endif %}>Newest</option>
                <option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>Oldest</option>
                <option value="most_liked" {% if request.args.get('sort') == 'most_liked' %}selected{% endif %}>Most Liked</option>
                <option value="least_liked" {% if request.args.get('sort') == 'least_liked' %}selected{% endif %}>Least Liked</option>
                <option value="type_Love Letter" {% if request.args.get('sort') == 'type_Love Letter' %}selected{% endif %}>Love Letters</option>
                <option value="type_Friend Request" {% if request.args.get('sort') == 'type_Friend Request' %}selected{% endif %}>Friend Requests</option>
                <option value="type_General Broadcast" {% if request.args.get('sort') == 'type_General Broadcast' %}selected{% endif %}>General Broadcasts</option>
            </select>
        </form>
    </div>

    {% for post in posts %}
        {% include 'components/postcard.html' %}
    {% endfor %}
    <!-- Skeleton Loader Template -->
<template id="skeleton-template">
    <div class="post-skeleton">
        <div class="skeleton-header"></div>
        <div class="skeleton-body"></div>
        <div class="skeleton-footer"></div>
    </div>
</template>

{% include 'components/reply.html' %}

<style>

.sort-posts select {
    font-size: 14px;  
    padding: 5px 10px; 
    margin-bottom: 20px;  
}

.sort-posts form {
    display: inline-block;  
}


.post-skeleton {
    margin: 10px 0;
    padding: 20px;
    background-color: #f0f0f0;
    border-radius: 5px;
}

.skeleton-header, .skeleton-body, .skeleton-footer {
    background: linear-gradient(to right, #eeeeee 8%, #dddddd 18%, #eeeeee 33%);
    background-size: 1000px 104px;
    height: 20px;
    margin: 10px 0;
    animation-duration: 1.2s;
    animation-fill-mode: forwards;
    animation-iteration-count: infinite;
    animation-name: shimmer;
    animation-timing-function: linear;
}

.skeleton-header {
    width: 70%;
}

.skeleton-body {
    width: 90%;
    height: 10px;
}

.skeleton-footer {
    width: 50%;
}

@keyframes shimmer {
    0% {
        background-position: -1000px 0;
    }
    100% {
        background-position: 1000px 0;
    }
}

</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let page = 1;
        let loading = false;
        let debounceTimer;
        let allPostsLoaded = false;
        let footerVisible = true; // Track the visibility of the footer
    
        function loadMorePosts() {
    if (loading || allPostsLoaded) return;
    loading = true;
    displaySkeletons(5);

    const sort = document.querySelector('select[name="sort"]').value; // Get current sort order

    setTimeout(() => {
        fetch(`/post/browse/${page + 1}?sort=${sort}`, { // Include sort parameter
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.posts.length > 0) {
                const container = document.querySelector('.container');
                container.insertAdjacentHTML('beforeend', data.posts);
                page += 1;
            } else {
                allPostsLoaded = true;
            }
        })
        .catch(error => {
            console.error('Error loading posts:', error);
        })
        .finally(() => {
            removeSkeletons();
            loading = false;
        });
    }, 600);
}
    
        function displaySkeletons(count) {
            const container = document.querySelector('.container');
            const skeletonTemplate = document.getElementById('skeleton-template').content;
            for (let i = 0; i < count; i++) {
                container.appendChild(document.importNode(skeletonTemplate, true));
            }
        }
    
        function removeSkeletons() {
            document.querySelectorAll('.post-skeleton').forEach(skeleton => skeleton.remove());
        }
    
        function handleScroll() {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            debounceTimer = setTimeout(() => {
                const scrollPosition = window.scrollY + window.innerHeight;
                const totalHeight = document.body.scrollHeight;
                const threshold = 300;
                if (scrollPosition >= totalHeight - threshold && !loading) {
                    loadMorePosts();
                    if (footerVisible) {
                        document.getElementById('page-footer').style.display = 'none'; // Hide the footer
                        footerVisible = false; // Update the visibility flag
                    }
                }
            }, 100);
        }
    
        window.addEventListener('scroll', handleScroll);
    });
    </script>
    
    
    



    
    
    
{% endblock %}
